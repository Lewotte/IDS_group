---
title: 'IDS investigation worksheet'
author: 'by GOMAKASHI: Sky, Hanna, Maggie, Marcel, Siddhi, Vivi'
date: '`r Sys.Date()`'
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(ggplot2)

#PACKAGES YOU MIGHT NEED TO INSTALL
library(readODS)
library(janitor) #for changing row names
library(RColorBrewer)

```


```{r load-data-and-func}
Ethnic_PD <- read_ods('data/Population_30June2023_Annual.ods', sheet = 14)
A1_7 <- read_ods('data/Population_30June2023_Annual.ods', sheet = 12)
TypeOfCrime <- read_ods('data/Population_30June2023_Annual.ods', sheet = 10)

#wrapper function for generating title of plots
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = '\n')
}

#normalises data to range from 0 to 1
normalise_01 <- function(x)
{
  if (min(x) < 0 )
  {
    x/max(abs(x))
  } else {
    (x-min(x))/(max(x)-min(x))
  }
}

```

# Ethnicity prison data
In this section, prison population is plotted as bar plots with 2 distinct visualisation formats.
<ol>
<li> In the 1st visualisation, colour corresponds to the value of the bars;</li>
<li> In the 2nd visualisation, colour corresponds to the change in population compared to the previous year.</li>
</ol>
```{r ethnicity-plot1}

male_allNat_Ethnic_PD <- Ethnic_PD %>%
  slice(.,34:40) %>% #ignores 'all nationalities' since it is redundant
  select(!2:9)

male_allNat_Ethnic_PD <- as.data.frame(t(male_allNat_Ethnic_PD)) %>%
  row_to_names(row_number = 1) %>%
  rename(
    `Asian_people` = 'Asian/ Asian British(2)',
    Other = 'Other ethnic group(2)',
    `Not_recorded` = 'Ethnic group not recorded',
    `Black_people` = 'Black/ African/ Caribbean/ Black British',
    `Mixed_or_Multiple` = 'Mixed/ Multiple ethnic groups',
    `White_people` = 'White'
  ) %>%
  #converts all columns to numeric
  mutate_all(~ as.numeric(.))

rownames(male_allNat_Ethnic_PD) <- NULL
male_allNat_Ethnic_PD$Year <- c(2009:2023)



### STARTS PLOTTING PRECEDURES

male_allNat_Ethnic_PD %>%
  #adds total
  mutate(All = rowSums(., !Year)) %>%
  #setting up data for the plot
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  #adds percentage
  mutate(group_p = normalise_01(count)) %>%
  
  #plotting
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  
  #styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of max and min within Ethnicity group',40)
  ) +
  # scale_fill_gradient(low='red', high='forestgreen', breaks = c(0,1))
  scale_fill_gradient(low='violetred3', high='chartreuse3',
                         breaks = c(0,0.5,1),
                       labels = c('min','','max')
                      )
```

```{r ethnicity-plot2}
  #plotting with different viz, namely difference between years
  
  male_allNat_Ethnic_PD %>%
  mutate(All = rowSums(., !Year)) %>%
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  mutate(group_p = c(0,normalise_01(diff(count,lag = 1)) ) ) %>%
  
  ### plot
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  annotate(
    "rect",
    xmin=2020-0.5, xmax=2022+0.5,
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  
  ### styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of difference from previous year within Ethnicity group',40)
  ) +
  scale_fill_gradient2(low='violetred3', mid='grey', high='chartreuse3',
                       midpoint = 0,
                         breaks = c(-1,0,1),
                       labels = c('decrease','no\n change','increase')
                      )
```

# Total prison data  
In this section, prison population is plotted as line graphs  
<ol>
<li> The first visualisation shows total prison population by type of custody </li>
<li> The second visualisations shows the difference from the previous data point (note that after 2009 every quarter is used rather than every year)</li>
<li> The third visualisation shows the rate of change weekly from the previous data point</li>
</ol>


```{r basic A1_7 plotting,fig.width=10, fig.height=5}

Annual_Data_A1_7 <- as.data.frame(A1_7)

#selects wanted data and the dates
Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  slice(1,2,13,24,35)

#cleans names
Annual_Data_A1_7[5,1] <- "Non-criminal prisoners"
Annual_Data_A1_7[2,1] <- "Total"

#makes the column names the Date
colnames(Annual_Data_A1_7)[-1] <- Annual_Data_A1_7[1,-1]

colnames(Annual_Data_A1_7)[1] <- "Group"

#pivots the data frame creating 3 columns being "Group","Date","Arrests"
Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  slice(-1) %>%
  pivot_longer(!Group, names_to = "Date", values_to = "Arrests") %>%
  mutate(Date = as.Date(Date, format = "%d-%m月-%y"),
         Arrests = as.numeric(Arrests)) 

Annual_Data_A1_7 <- na.omit(Annual_Data_A1_7)

#basic data plot by Group
ggplot(data = (Annual_Data_A1_7),
       mapping = aes( 
         x = Date,
         y = Arrests,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free") 
```

```{r A1_7 change plotting,fig.width=10, fig.height=5}
#Calculates the difference of previous value (note first value is set to NA)
diff_Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  group_by(Group) %>%
  mutate(Arrests_diff = c(NA, diff(Arrests))) %>%
  ungroup()
#plots difference between each data point by group
ggplot(data = na.omit(diff_Annual_Data_A1_7),
       mapping = aes( 
         x = Date,
         y = Arrests_diff,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free") 
 
```

```{r Gradient of A1_7,fig.width=10, fig.height=5}
#calculates the gradient (rate of change) per week and is similar to previous
#per month might be better but to add in you must do ... units = "days")) /30.437) (30.437 is average days in a month)
grad_Annual_Data_A1_7 <- diff_Annual_Data_A1_7 %>%
  group_by(Group) %>%
  mutate(
    Date_diff = c(NA, as.numeric(difftime(Date[-1], Date[-length(Date)], units = "weeks"))),
    Gradient = Arrests_diff / Date_diff
    ) %>%
  ungroup()

#plots gradient by group
ggplot(data = na.omit(grad_Annual_Data_A1_7),
       mapping = aes( 
         x = Date,
         y = Gradient,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free") 
```

```{r Type of Crime,fig.width=10, fig.height=5}
Type_of_Crime_Graph <- as.data.frame(TypeOfCrime)

#selects wanted data and the dates
Type_of_Crime_Graph <- Type_of_Crime_Graph %>%
  slice(1,2,3,13,16,17,22,25,31,34)

#cleans names
#Annual_Data_A1_7[5,1] <- "Non-criminal prisoners"
#Annual_Data_A1_7[2,1] <- "Total"

#makes the column names the Date
colnames(Type_of_Crime_Graph)[-1] <- Type_of_Crime_Graph[1,-1]

colnames(Type_of_Crime_Graph)[1] <- "Group"

#pivots the data frame creating 3 columns being "Group","Date","Arrests"
Type_of_Crime_Graph <- Type_of_Crime_Graph %>%
  slice(-1) %>%
  pivot_longer(!Group, names_to = "Date", values_to = "Arrests") %>%
  mutate(Date = as.Date(Date, format = "%d-%m月-%y"),
         Arrests = as.numeric(Arrests)) 

Type_of_Crime_Graph <- na.omit(Type_of_Crime_Graph)

#basic data plot by Group
ggplot(data = (Type_of_Crime_Graph),
       mapping = aes( 
         x = Date,
         y = Arrests,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free")  
```