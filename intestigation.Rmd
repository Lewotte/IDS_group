---
title: 'IDS investigation worksheet'
author: 'by GOMAKASHI: Sky, Hanna, Maggie, Marcel, Siddhi, Vivi'
date: '`r Sys.Date()`'
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(ggplot2)

#PACKAGES YOU MIGHT NEED TO INSTALL
library(readODS)
library(janitor) #for changing row names
library(RColorBrewer)

```


```{r load-data-and-func}
Ethnic_PD <- read_ods('data/Population_30June2023_Annual.ods', sheet = 14)
Annual_Data_A1_7 <- read_ods('data/Population_30June2023_Annual.ods', sheet = 12)

#wrapper function for generating title of plots
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = '\n')
}

#normalises data to range from 0 to 1
normalise_01 <- function(x)
{
  if (min(x) < 0 )
  {
    x/max(abs(x))
  } else {
    (x-min(x))/(max(x)-min(x))
  }
}

```

# Ethnicity prison data
In this section, prison population is plotted as bar plots with 2 distinct visualisation formats.
<ol>
<li> In the 1st visualisation, colour corresponds to the value of the bars;</li>
<li> In the 2nd visualisation, colour corresponds to the change in population compared to the previous year.</li>
</ol>
```{r ethnicity-plot1}

male_allNat_Ethnic_PD <- Ethnic_PD %>%
  slice(.,34:40) %>% #ignores 'all nationalities' since it is redundant
  select(!2:9)

male_allNat_Ethnic_PD <- as.data.frame(t(male_allNat_Ethnic_PD)) %>%
  row_to_names(row_number = 1) %>%
  rename(
    `Asian_people` = 'Asian/ Asian British(2)',
    Other = 'Other ethnic group(2)',
    `Not_recorded` = 'Ethnic group not recorded',
    `Black_people` = 'Black/ African/ Caribbean/ Black British',
    `Mixed_or_Multiple` = 'Mixed/ Multiple ethnic groups',
    `White_people` = 'White'
  ) %>%
  #converts all columns to numeric
  mutate_all(~ as.numeric(.))

rownames(male_allNat_Ethnic_PD) <- NULL
male_allNat_Ethnic_PD$Year <- c(2009:2023)



### STARTS PLOTTING PRECEDURES

male_allNat_Ethnic_PD %>%
  #adds total
  mutate(All = rowSums(., !Year)) %>%
  #setting up data for the plot
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  #adds percentage
  mutate(group_p = normalise_01(count)) %>%
  
  #plotting
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  
  #styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of max and min within Ethnicity group',40)
  ) +
  # scale_fill_gradient(low='red', high='forestgreen', breaks = c(0,1))
  scale_fill_gradient(low='violetred3', high='chartreuse3',
                         breaks = c(0,0.5,1),
                       labels = c('min','','max')
                      )
```

```{r ethnicity-plot2}
  #plotting with different viz, namely difference between years
  
  male_allNat_Ethnic_PD %>%
  mutate(All = rowSums(., !Year)) %>%
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  mutate(group_p = c(0,normalise_01(diff(count,lag = 1)) ) ) %>%
  
  ### plot
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  annotate(
    "rect",
    xmin=2020-0.5, xmax=2022+0.5,
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  
  ### styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of difference from previous year within Ethnicity group',40)
  ) +
  scale_fill_gradient2(low='violetred3', mid='grey', high='chartreuse3',
                       midpoint = 0,
                         breaks = c(-1,0,1),
                       labels = c('decrease','no\n change','increase')
                      )
```

```{r basic A1_7 plotting,fig.width=10, fig.height=5}
###doesnt work as it replaces the month with æœˆ? 

Date_A1_7 <- as.character(Annual_Data_A1_7[1,])

colnames(Annual_Data_A1_7) <- Date_A1_7 
#creates the column names as the date 
Annual_Data_A1_7 <- Annual_Data_A1_7[-1, ] 
colnames(Annual_Data_A1_7)[1]<-"Group" 
#creates column name for the groups 
Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  slice(1,12,23,34) %>%
  pivot_longer(!Group, names_to = "Date", values_to = "Arrests") %>%
  mutate(Date = as.Date(Date, format = "%d-%b-%y"),
         Arrests = as.numeric(Arrests)) 
#pivots with selected data 
ggplot(data = Annual_Data_A1_7,
       mapping = aes( 
         x = Date,
         y = Arrests,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free") 
#plots the data by group 
```