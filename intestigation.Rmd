---
title: 'IDS investigation worksheet'
author: 'by GOMAKASHI: Sky, Hanna, Maggie, Marcel, Siddhi, Vivi'
date: '`r Sys.Date()`'
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)

#PACKAGES YOU MIGHT NEED TO INSTALL
library(readODS)
library(janitor) #for changing row names
library(RColorBrewer)

```


```{r load-data-and-func}
Ethnic_PD <- read_ods('data/Population_30June2023_Annual.ods', sheet = 14)
A1_7 <- read_ods('data/Population_30June2023_Annual.ods', sheet = 12)
TypeOfCrime <- read_ods('data/Population_30June2023_Annual.ods', sheet = 10)
Custody_PD <- read_ods('data/Population_30June2023_Annual.ods', sheet = 2)

#wrapper function for generating title of plots
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = '\n')
}

#normalises data to range from 0 to 1
normalise_01 <- function(x)
{
  if (min(x) < 0 )
  {
    x/max(abs(x))
  } else {
    (x-min(x))/(max(x)-min(x))
  }
}

```

```{r custody-type}
#use facet grid: (<Male/Female>,<Age group>, <custody type>)
offset <- 2

Custody_PD_sliced <- Custody_PD %>%
  row_to_names(row_number = 1) %>%
    rename("Custody" = 1) %>%
  rename("30-6-09" = 10) %>%
  select(!9) %>%
  #removing rows we don't want
  slice(-c(1:(118-offset),(185-offset):(212-offset),(279-offset):nrow(.))) %>% #looks at male and female separately, gets 6 blocks (3 age groups for 2 genders, ignores blocks for total)
  slice(-seq.int(1,5*22+1,by=22)) %>% #removes columns containing totals per category
  cbind(
    #Manually renames age and gender category
    Gender = rep(c("Male","Female"), rep(63,2)),
    Age = rep(c("Adult","18-20", "15-17"), rep(21,3))
  ) %>%
  replace(., . == "-", NA) %>%
  
  pivot_longer(!c("Custody", "Gender", "Age"), names_to = "Date", values_to = "Count") %>%
  mutate(Count = as.numeric(Count),
         Date = dmy(Date),
         year = year(Date), month = month(Date), day = day(Date)) %>%
  #filter
  filter(year >= 2015,
         Custody == c("10 years to less than 14 years",
                      "12 months to less than 4 years"
                      )
         ) %>%
  
  #grouping for plot visuals
  group_by(Custody, Gender) %>%
  mutate(perc_count_gender = Count/sum(Count, na.rm = TRUE)) 

  
  ###plotting
  custody_plot <- ggplot(data = Custody_PD_sliced,
    aes(x = Date, y = perc_count_gender, group = Gender)) +
    geom_line(aes(group = Gender, colour = Gender),
           ) +
    facet_grid(vars(Age), vars(Custody), scales = "free_y") +
    scale_color_manual(values = c(Male = "chocolate2",Female = "royalblue")) +
    labs(x = "Time", y = "Population percentage") +
    theme(text = element_text(size = 10))
  
print(custody_plot)
  
  #in = 100 pixels. Keep commented unless need to export plot
  # ggsave("img/custody_plot_gender2.jpg", plot = custody_plot, width = 46, height = 7, units = "in")
  
```

# Ethnicity prison data
In this section, prison population is plotted as bar plots with 2 distinct visualisation formats.
<ol>
<li> In the 1st visualisation, colour corresponds to the value of the bars;</li>
<li> In the 2nd visualisation, colour corresponds to the change in population compared to the previous year.</li>
</ol>
```{r ethnicity-plot1}

male_allNat_Ethnic_PD <- Ethnic_PD %>%
  slice(.,34:40) %>% #ignores 'all nationalities' since it is redundant
  select(!2:9)

male_allNat_Ethnic_PD <- as.data.frame(t(male_allNat_Ethnic_PD)) %>%
  row_to_names(row_number = 1) %>%
  rename(
    `Asian_people` = 'Asian/ Asian British(2)',
    Other = 'Other ethnic group(2)',
    `Not_recorded` = 'Ethnic group not recorded',
    `Black_people` = 'Black/ African/ Caribbean/ Black British',
    `Mixed_or_Multiple` = 'Mixed/ Multiple ethnic groups',
    `White_people` = 'White'
  ) %>%
  #converts all columns to numeric
  mutate_all(~ as.numeric(.))

rownames(male_allNat_Ethnic_PD) <- NULL
male_allNat_Ethnic_PD$Year <- c(2009:2023)



### STARTS PLOTTING PRECEDURES

male_allNat_Ethnic_PD %>%
  #adds total
  mutate(All = rowSums(., !Year)) %>%
  #setting up data for the plot
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  #adds percentage
  mutate(group_p = normalise_01(count)) %>%
  
  #plotting
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  
  #styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of max and min within Ethnicity group',40)
  ) +
  # scale_fill_gradient(low='red', high='forestgreen', breaks = c(0,1))
  scale_fill_gradient(low='violetred3', high='chartreuse3',
                         breaks = c(0,0.5,1),
                       labels = c('min','','max')
                      )
```

```{r ethnicity-plot2}
  #plotting with different viz, namely difference between years
  
  male_allNat_Ethnic_PD %>%
  mutate(All = rowSums(., !Year)) %>%
  pivot_longer(!Year, names_to = 'Ethnicity', values_to = 'count') %>%
  group_by(Ethnicity) %>%
  
  mutate(group_p = c(0,normalise_01(diff(count,lag = 1)) ) ) %>%
  
  ### plot
  ggplot(
    aes(
      x = Year,
      y = count,
      fill = group_p
    )
  ) +
  geom_bar(
    aes(
      group = Ethnicity
    ),
    stat = 'identity',
  ) +
  facet_wrap(~Ethnicity,
             scales = 'free_y',
             shrink = FALSE,
             nrow = 2,
             ncol = 4) +
  annotate(
    "rect",
    xmin=2020-0.5, xmax=2022+0.5,
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  
  ### styling
  theme_light() +
  theme(
    legend.position = 'bottom',
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(
    x = 'Year',
    y = 'Number of people',
    title = wrapper('Prison population in England and Wales, grouped by ethnicity, from year 2009 to 2023', 60),
    fill = wrapper('normalised indicator of difference from previous year within Ethnicity group',40)
  ) +
  scale_fill_gradient2(low='violetred3', mid='grey', high='chartreuse3',
                       midpoint = 0,
                         breaks = c(-1,0,1),
                       labels = c('decrease','no\n change','increase')
                      )
```

# Total prison data  
In this section, prison population is plotted as line graphs  
<ol>
<li> The first visualisation shows total prison population by type of custody </li>
<li> The second visualisations shows the difference from the previous data point (note that after 2009 every quarter is used rather than every year)</li>
<li> The third visualisation shows the rate of change weekly from the previous data point</li>
</ol>


```{r basic A1_7 plotting,fig.width=10, fig.height=5}

Annual_Data_A1_7 <- as.data.frame(A1_7)

#selects wanted data and the dates
Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  slice(1,2,13,24,35)

#cleans names
Annual_Data_A1_7[5,1] <- "Non-criminal prisoners"
Annual_Data_A1_7[2,1] <- "Total"

#makes the column names the Date
colnames(Annual_Data_A1_7)[-1] <- Annual_Data_A1_7[1,-1]

colnames(Annual_Data_A1_7)[1] <- "Group"

#pivots the data frame creating 3 columns being "Group","Date","Arrests"
Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  slice(-1) %>%
  pivot_longer(!Group, names_to = "Date", values_to = "Arrests") %>%
  mutate(Date = as.Date(Date, format = "%d-%mæœˆ-%y"),
         Arrests = as.numeric(Arrests)) 

Annual_Data_A1_7 <- na.omit(Annual_Data_A1_7)

#basic data plot by Group
ggplot(data = (Annual_Data_A1_7),
       mapping = aes( 
         x = Date,
         y = Arrests,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  facet_wrap(~Group, scales = "free") 
```

```{r A1_7 change plotting,fig.width=10, fig.height=5}
#Calculates the % change from previous value (note first value is set to NA)
diff_Annual_Data_A1_7 <- Annual_Data_A1_7 %>%
  filter(year(Date) > 2009) %>%
  arrange(Group, Date) %>%
  group_by(Group) %>%
  mutate(
    Arrests_diff = c(NA, diff(Arrests)),
    Arrests_pct_change = (Arrests_diff / lag(Arrests)) * 100
    ) %>%
  ungroup
Total_group_data <- diff_Annual_Data_A1_7 %>%
  filter(Group == "Total")
#plots difference between each data point by group
ggplot(data = na.omit(Total_group_data),
       mapping = aes( 
         x = Date,
         y = Arrests_pct_change,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  annotate(
    "rect",
    xmin= as.Date("2012-01-01"), xmax=as.Date("2014-06-01"),
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  annotate(
    "rect",
    xmin= as.Date("2017-03-01"), xmax=as.Date("2020-01-01"),
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  facet_wrap(~Group, scales = "free")

 
```

```{r Gradient of A1_7,fig.width=10, fig.height=5}
#quarter is measured in days / 91.3125 (Ave days in a quarter)
grad_Annual_Data_A1_7 <- diff_Annual_Data_A1_7 %>%
  filter(year(Date) > 2009) %>%
  arrange(Group, Date) %>%
  group_by(Group) %>%
  mutate(
    Date_diff = c(NA, as.numeric(difftime(Date[-1], Date[-length(Date)], units = "days")/ 91.3125)),
    Gradient = Arrests_diff / Date_diff
    ) %>%
  ungroup()
Total_group_data <- grad_Annual_Data_A1_7 %>%
  filter(Group == "Total")

#plots gradient by group
ggplot(data = na.omit(Total_group_data),
       mapping = aes( 
         x = Date,
         y = Gradient,
         group = Group,
         colour = Group)) + 
  geom_line(size = 1) + 
  annotate(
    "rect",
    xmin= as.Date("2012-01-01"), xmax=as.Date("2014-06-01"),
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  annotate(
    "rect",
    xmin= as.Date("2017-03-01"), xmax=as.Date("2020-01-01"),
    ymin=-Inf, ymax=Inf,
    alpha = 0.2, fill = "black", color = "black"
  ) +
  facet_wrap(~Group, scales = "free") 
```

```{r Type of Crime,fig.width=10, fig.height=5}
Lockdown_data <- Annual_Data_A1_7
Lockdown_data$prison_population <- Lockdown_data$Arrests

# Ensure the Date column is in Date format
Lockdown_data$Date <- as.Date(Lockdown_data$Date)

# Define lockdown periods 
Lockdown_data$lockdown <- ifelse(
  (Lockdown_data$Date >= "2020-03-23" & Lockdown_data$Date <= "2020-07-04") |  # First lockdown
  (Lockdown_data$Date >= "2020-11-05" & Lockdown_data$Date <= "2020-12-02") |  # Second lockdown
  (Lockdown_data$Date >= "2021-01-06" & Lockdown_data$Date <= "2021-03-29"),   # Third lockdown
  1,  # Assign 1 during lockdown
  0   # Assign 0 otherwise
)

library(tidymodels)            

# Fit the linear model using tidymodels syntax
model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(prison_population ~ lockdown, 
      data = Lockdown_data)

# View the model coefficients
tidy(model)

```
